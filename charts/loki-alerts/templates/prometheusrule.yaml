{{- if .Values.alerts.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: loki-alerts
  namespace: {{ .Values.alerts.namespace }}
  labels:
    release: prometheus
spec:
  groups:
    - name: application-logs
      interval: 1m
      rules:
        - alert: YtDlpAasErrors
          expr: |
            sum(count_over_time({namespace="arr-stack", app="ytdlpaas"} |= "ERROR" [5m])) > 0
          for: 1m
          labels:
            severity: warning
            namespace: arr-stack
          annotations:
            summary: "yt-dlp-aas is logging errors"
            description: "The yt-dlp-aas service has logged {{ $value }} errors in the last 5 minutes. Check logs for details."

        - alert: YtDlpAas403Errors
          expr: |
            sum(count_over_time({namespace="arr-stack", app="ytdlpaas"} |~ "ERROR.*HTTP Error 403|ERROR.*403 Forbidden" [5m])) > 0
          for: 1m
          labels:
            severity: critical
            namespace: arr-stack
          annotations:
            summary: "yt-dlp-aas encountering 403 errors"
            description: "The yt-dlp-aas service has encountered {{ $value }} 403 Forbidden errors in the last 5 minutes. This likely means yt-dlp needs an update."

        - alert: YtDlpAasSignatureExtractionFailure
          expr: |
            sum(count_over_time({namespace="arr-stack", app="ytdlpaas"} |= "Signature extraction failed" [5m])) > 0
          for: 1m
          labels:
            severity: critical
            namespace: arr-stack
          annotations:
            summary: "yt-dlp-aas signature extraction failures"
            description: "The yt-dlp-aas service has encountered {{ $value }} signature extraction failures in the last 5 minutes. This likely means yt-dlp needs an update."
{{- end }}
